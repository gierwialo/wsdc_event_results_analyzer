<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSDC Event Results Analyzer</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" x-data="resultsAnalyzer" x-cloak>
        <div class="card">
            <h1>üìä WSDC Event Results Analyzer</h1>
            <p class="subtitle">Paste a link to results from scoring.dance</p>

            <div class="input-group">
                <input
                    type="url"
                    x-model="url"
                    placeholder="Direct link to scoring.dance event result"
                    @keyup.enter="loadResults()"
                    aria-label="Event results URL"
                    :aria-invalid="!!error"
                >
                <button
                    @click="loadResults()"
                    :disabled="loading || !url"
                    :aria-busy="loading"
                >
                    <span x-show="!loading">Load</span>
                    <span x-show="loading">Loading...</span>
                </button>
            </div>

            <div
                x-show="error"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="alert alert-error"
                role="alert"
                x-text="error">
            </div>
            <div
                x-show="successMessage"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="alert alert-success"
                role="status"
                x-text="successMessage">
            </div>
        </div>

        <div x-show="loading" class="card" aria-live="polite" aria-busy="true">
            <div class="loading">
                <div class="spinner" role="status" aria-label="Loading results"></div>
                <p>Fetching data from scoring.dance...</p>
            </div>
        </div>

        <template x-if="results && !loading">
            <div class="card">
                <div class="event-info" x-show="eventInfo">
                <h2 x-text="eventInfo?.name"></h2>
                <p><strong>Category:</strong> <span x-text="eventInfo?.category"></span></p>
                <p><strong>Date:</strong> <span x-text="eventInfo?.date"></span></p>
                <p><strong>Location:</strong> <span x-text="eventInfo?.location"></span></p>
                <p class="judges-list"><strong>Judges:</strong> <span x-text="eventInfo?.judges"></span></p>
                <p><strong>Scoring system:</strong> <span x-text="eventInfo?.calculationModel"></span></p>
            </div>

            <h3 class="results-header">
                Results (<span x-text="results?.length || 0"></span> couples)
                <span x-show="calculatingRPSS" class="calculating-badge">
                    Calculating placements...
                </span>
            </h3>

            <div x-show="hasModifications" class="button-group">
                <button @click="recalculate()" class="btn-recalculate">
                    Recalculate
                </button>
                <button @click="reset()" class="btn-reset">
                    Reset
                </button>
            </div>

            <div class="table-wrapper">
                <table>
                    <caption class="visually-hidden">Competition results with judge scores and calculated placements</caption>
                    <thead>
                        <tr>
                            <th scope="col" :class="{'grayed-out': hasModifications}">Place</th>
                            <th scope="col">Calc Place</th>
                            <th scope="col">Bib</th>
                            <th scope="col">Leader</th>
                            <th scope="col">Follower</th>
                            <template x-for="judge in judges" :key="judge">
                                <th scope="col" class="judge-score" x-text="judge"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="result in results" :key="`${result.leaderBib}-${result.followerBib}`">
                            <tr :class="getRowClass(result)">
                                <td :class="{'grayed-out': hasModifications}">
                                    <span
                                        class="place"
                                        :class="'place-' + result.place"
                                        x-text="result.place"
                                    ></span>
                                </td>
                                <td>
                                    <div>
                                        <span
                                            class="calculated-place"
                                            :class="getPlaceClass(result)"
                                            :title="getPlaceTitle(result)"
                                        >
                                            <span x-text="result.calculatedPlace || '?'"></span>
                                            <span x-show="hasModifications && result.calculatedPlace < result.place" class="place-indicator">‚¨ÜÔ∏è</span>
                                            <span x-show="hasModifications && result.calculatedPlace > result.place" class="place-indicator">‚¨áÔ∏è</span>
                                        </span>
                                        <div class="calc-details" x-show="result.calcDetails">
                                            <span x-text="result.calcDetails"></span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="bib" x-text="result.leaderBib"></span> /
                                    <span class="bib" x-text="result.followerBib"></span>
                                </td>
                                <td x-text="result.leader"></td>
                                <td x-text="result.follower"></td>
                                <template x-for="(judge, judgeIdx) in judges" :key="judge">
                                    <td class="judge-score" :class="{ 'modified-cell': isModified(judgeIdx, result.originalIndex) }">
                                        <input
                                            type="number"
                                            :value="getCurrentScore(judgeIdx, result.originalIndex)"
                                            @change="handleScoreChange(judgeIdx, result.originalIndex, $event)"
                                            min="1"
                                            :max="results.length"
                                            class="score-input"
                                        >
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            </div>
        </template>

        <!-- Step-by-step breakdown -->
        <template x-if="auditTrail && !loading">
            <div class="card">
            <h3 class="results-header">
                üìã Step-by-Step Calculation Breakdown
            </h3>
            <p class="subtitle audit-subtitle">
                Follow how the RPSS algorithm determines each placement, step by step.
            </p>

            <div class="audit-container">
                <template x-for="step in auditTrail" :key="step.step">
                    <div class="audit-step" :class="'audit-step-' + step.type">
                        <div class="audit-step-number">
                            <span x-text="step.step"></span>
                        </div>
                        <div class="audit-step-content">
                            <div class="audit-step-message" x-text="step.message"></div>
                            <div x-show="step.k" class="audit-step-meta">
                                <span class="audit-meta-badge">k = <span x-text="step.k"></span></span>
                                <span x-show="step.majorityCount" class="audit-meta-badge">
                                    Majority: <span x-text="step.majorityCount"></span>/<span x-text="auditInfo?.totalJudges"></span>
                                </span>
                                <span x-show="step.sum" class="audit-meta-badge">
                                    Sum: <span x-text="step.sum"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Legend -->
            <div class="legend-container">
                <h4 class="legend-title">üìñ Legend & Terminology</h4>

                <div class="legend-section">
                    <h5 class="legend-section-title">Step Types (Colors)</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-color legend-color-init"></span>
                            <strong>Init</strong> - Algorithm initialization
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-color-iteration"></span>
                            <strong>Iteration</strong> - Starting new place calculation
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-color-check"></span>
                            <strong>Check</strong> - Checking couples at level k
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-color-tie"></span>
                            <strong>Tie</strong> - Multiple couples tied, need tie-break
                        </div>
                        <div class="legend-item">
                            <span class="legend-color legend-color-assign"></span>
                            <strong>Assign</strong> - Place successfully assigned to couple
                        </div>
                    </div>
                </div>

                <div class="legend-section">
                    <h5 class="legend-section-title">Key Terms</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <strong>k</strong> - Current placement level being checked (e.g., k=2 means checking how many judges placed couple in top 2)
                        </div>
                        <div class="legend-item">
                            <strong>Majority</strong> - Minimum number of judges needed (>50%) to determine a placement. Formula: floor(J/2) + 1
                        </div>
                        <div class="legend-item">
                            <strong>maj</strong> - How many judges gave this couple a placement ‚â§ k (e.g., maj=5/7 means 5 out of 7 judges)
                        </div>
                        <div class="legend-item">
                            <strong>Sum</strong> - Sum of ordinal placements ‚â§ k, used to break ties (lower is better)
                        </div>
                        <div class="legend-item">
                            <strong>Ordinals</strong> - Individual judge placements (rankings) for each couple
                        </div>
                    </div>
                </div>

                <div class="legend-section">
                    <h5 class="legend-section-title">How RPSS Works</h5>
                    <div class="legend-description">
                        <p><strong>1. Majority Rule:</strong> A couple gets a placement when a majority of judges (>50%) rank them at that level or better.</p>
                        <p><strong>2. Level-by-level:</strong> Start at k=1 (1st place), then k=2 (top 2), k=3 (top 3), etc., until someone has majority.</p>
                        <p><strong>3. Tie-breaking:</strong> If multiple couples have the same majority count, use sum of their ordinals ‚â§ k (lower sum wins).</p>
                        <p><strong>4. Expand k:</strong> If still tied after sum, expand to k+1, k+2, etc., and compare majority counts at higher levels.</p>
                        <p><strong>5. Head-to-head:</strong> Final tie-breaker for 2 couples: count which couple is ranked higher by more judges.</p>
                    </div>
                </div>
            </div>
            </div>
        </template>

        <!-- References / Sources -->
        <template x-if="results && !loading">
            <div class="card">
                <h3 class="results-header">
                    üìö References & Sources
                </h3>
                <p class="subtitle references-subtitle">
                    Documentation and resources used in this implementation.
                </p>

            <div class="references-container">
                <div class="reference-section">
                    <ul class="reference-list">
                        <li>
                            <a href="https://www.worldsdc.com/wp-content/uploads/2021/04/Relative-Placement-12-20-20-Rev-5-1-10-1.pdf" target="_blank" rel="noopener noreferrer">
                                Relative Placement Scoring System (WSDC-approved)
                            </a>
                            <span class="reference-note">Official document explaining the Relative Placement algorithm step by step: majority definition (>50%), ‚â§k threshold iteration, tie-breaks with ordinal sums within threshold, example tables and full WSDC-compliant procedure.</span>
                        </li>
                        <li>
                            <a href="https://www.worldsdc.com/rules/" target="_blank" rel="noopener noreferrer">
                                Rules & Info (WSDC)
                            </a>
                            <span class="reference-note">Hub page with regulations: links to RPSS, Prelim Scoring, templates and examples. Confirms that WSDC finals use Relative Placement system and where to find official materials.</span>
                        </li>
                        <li>
                            <a href="https://www.worldsdc.com/wp-content/uploads/2024/12/wsdcrules.pdf" target="_blank" rel="noopener noreferrer">
                                WSDC Registry Event Rules (effective Jan 1, 2025)
                            </a>
                            <span class="reference-note">Current rules for events: require use of Relative Placement in finals and computerized scoring systems; specify minimum judging panels, preliminary standards and scoring system requirements.</span>
                        </li>
                    </ul>
                </div>
            </div>
            </div>
        </template>
    </div>

    <script src="app.js"></script>
</body>
</html>
